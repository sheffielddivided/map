<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aker BP – Licence Map</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #0a1628; color: #e0e8f0; height: 100vh; display: flex; flex-direction: column; }
    header { background: linear-gradient(90deg, #0a1628 0%, #112244 100%); border-bottom: 2px solid #1e5fa8; padding: 12px 20px; display: flex; align-items: center; gap: 16px; z-index: 1000; flex-wrap: wrap; }
    .logo { display: flex; align-items: center; }
    header h1 { font-size: 15px; font-weight: 400; color: #8ab0d0; }
    .controls { margin-left: auto; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .legend-btn { background: #1e3a5f; border: 1px solid #2a5a8f; color: #c0d8f0; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: background 0.2s; }
    .legend-btn:hover { background: #2a5a8f; }
    .legend-btn.active { background: #1e5fa8; border-color: #4a9eff; color: #fff; }
    #map { flex: 1; }
    #loading { position: fixed; inset: 0; background: rgba(10,22,40,0.88); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; gap: 16px; }
    #loading.hidden { display: none; }
    .spinner { width: 48px; height: 48px; border: 4px solid #1e3a5f; border-top-color: #4a9eff; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading p { color: #8ab0d0; font-size: 14px; }
    #sidebar { position: absolute; top: 70px; right: 16px; width: 320px; background: rgba(10,22,40,0.97); border: 1px solid #1e5fa8; border-radius: 10px; z-index: 800; overflow: hidden; box-shadow: 0 4px 24px rgba(0,0,0,0.6); max-height: calc(100vh - 100px); display: flex; flex-direction: column; }
    #sidebar.hidden { display: none; }
    .sidebar-header { background: #0e2240; padding: 12px 16px; border-bottom: 1px solid #1e3a5f; display: flex; justify-content: space-between; align-items: center; }
    .sidebar-header h2 { font-size: 14px; color: #4a9eff; font-weight: 600; }
    .close-btn { background: none; border: none; color: #8ab0d0; cursor: pointer; font-size: 18px; }
    .sidebar-content { padding: 10px 14px; overflow-y: auto; }
    .info-section-title { font-size: 11px; color: #4a9eff; text-transform: uppercase; letter-spacing: 1px; margin: 10px 0 4px; border-top: 1px solid #1a2e48; padding-top: 8px; }
    .info-section-title:first-child { border-top: none; margin-top: 0; padding-top: 0; }
    .info-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #1a2e48; font-size: 13px; gap: 8px; }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #8ab0d0; white-space: nowrap; flex-shrink: 0; }
    .info-value { color: #e0e8f0; font-weight: 500; text-align: right; }
    #statsbar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(10,22,40,0.92); border: 1px solid #1e5fa8; border-radius: 30px; padding: 8px 24px; display: flex; gap: 24px; z-index: 800; font-size: 13px; white-space: nowrap; }
    .stat { display: flex; align-items: center; gap: 8px; }
    .stat-dot { width: 12px; height: 12px; border-radius: 3px; }
    .dot-field { background: #00b373; } .dot-licence { background: #ce0f69; } .dot-unit { background: #ce0f69; }
    .stat-label { color: #8ab0d0; }
    .stat-count { color: #fff; font-weight: 700; font-size: 15px; margin-left: 2px; }
    #maplegend { position: absolute; top: 70px; left: 16px; background: rgba(10,22,40,0.94); border: 1px solid #1e5fa8; border-radius: 10px; padding: 14px; z-index: 800; min-width: 230px; }
    #maplegend.hidden { display: none; }
    #maplegend h3 { font-size: 11px; color: #4a9eff; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
    .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 7px; font-size: 13px; color: #c0d8f0; }
    .legend-swatch { width: 26px; height: 14px; border-radius: 3px; flex-shrink: 0; }
    #errormsg { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: #3a1010; border: 1px solid #a03030; color: #ff8080; padding: 12px 20px; border-radius: 8px; z-index: 1000; font-size: 13px; max-width: 500px; text-align: center; }
    #errormsg.hidden { display: none; }
    .tooltip-dark { background: rgba(10,22,40,0.95) !important; border: 1px solid #1e5fa8 !important; color: #e0e8f0 !important; border-radius: 6px !important; padding: 5px 10px !important; font-size: 12px !important; font-family: 'Segoe UI', sans-serif !important; box-shadow: 0 2px 8px rgba(0,0,0,0.5) !important; }
    .leaflet-tooltip.tooltip-dark::before { display: none !important; }

    /* Permanent map labels */
    .map-label {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      font-family: 'Segoe UI', sans-serif !important;
      font-size: 11px !important;
      font-weight: 600 !important;
      pointer-events: none !important;
      white-space: nowrap !important;
      text-shadow: 0 0 3px #000, 0 0 6px #000, 0 0 10px #000 !important;
      padding: 0 !important;
    }
    /* Light basemap: dark outline instead of black glow */
    body.basemap-light .map-label {
      text-shadow: 0 0 3px #fff, 0 0 6px #fff, 0 0 10px #fff, 1px 1px 0 #fff, -1px -1px 0 #fff !important;
    }
    body.basemap-light .map-label-licence { color: #9a0048 !important; }
    body.basemap-light .map-label-unit    { color: #9a0048 !important; }
    body.basemap-light .map-label-field   { color: #007a50 !important; }
    body.basemap-light .map-label-office  { color: #1a6abf !important; }
    body.basemap-light .map-label-discovery { color: #b8900a !important; }
    .map-label::before { display: none !important; }
    .map-label-licence { color: #ce0f69 !important; font-size: 10px !important; font-weight: 700 !important; }
    .map-label-unit    { color: #ce0f69 !important; font-size: 11px !important; font-weight: 700 !important; }
    .map-label-field   { color: #00b373 !important; font-size: 11px !important; font-weight: 700 !important; }
    .map-label-office     { color: #4a9eff !important; font-size: 11px !important; font-weight: 600 !important; }
    .map-label-discovery  { color: #ffdc00 !important; font-size: 10px !important; font-weight: 600 !important; }
    /* ── Customise panel ──────────────────────────────────────────────── */
    #customise-panel {
      position: absolute; top: 70px; right: 16px; width: 310px;
      background: rgba(10,22,40,0.97); border: 1px solid #1e5fa8;
      border-radius: 10px; z-index: 900;
      box-shadow: 0 4px 24px rgba(0,0,0,0.6);
      max-height: calc(100vh - 100px); display: flex; flex-direction: column;
    }
    #customise-panel.hidden { display: none; }
    .cp-header {
      background: #0e2240; padding: 12px 16px;
      border-bottom: 1px solid #1e3a5f;
      display: flex; justify-content: space-between; align-items: center;
    }
    .cp-header h2 { font-size: 14px; color: #4a9eff; font-weight: 600; }
    .cp-body { padding: 12px 14px; overflow-y: auto; }
    .cp-section { margin-bottom: 16px; }
    .cp-section:last-child { margin-bottom: 0; }
    .cp-section-title {
      font-size: 11px; color: #4a9eff; text-transform: uppercase;
      letter-spacing: 1px; margin-bottom: 10px;
      border-bottom: 1px solid #1a2e48; padding-bottom: 5px;
    }
    .cp-row {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 8px; gap: 8px; font-size: 13px;
    }
    .cp-row:last-child { margin-bottom: 0; }
    .cp-label { color: #c0d8f0; flex: 1; }
    /* Label toggle switch */
    .cp-toggle {
      position: relative; width: 36px; height: 20px; flex-shrink: 0;
    }
    .cp-toggle input { opacity: 0; width: 0; height: 0; }
    .cp-slider {
      position: absolute; inset: 0; background: #1e3a5f;
      border-radius: 20px; cursor: pointer; transition: background 0.2s;
    }
    .cp-slider::before {
      content: ''; position: absolute; width: 14px; height: 14px;
      left: 3px; top: 3px; background: #8ab0d0;
      border-radius: 50%; transition: transform 0.2s, background 0.2s;
    }
    .cp-toggle input:checked + .cp-slider { background: #1e5fa8; }
    .cp-toggle input:checked + .cp-slider::before { transform: translateX(16px); background: #fff; }
    .cp-reset {
      display: block; width: 100%; margin-top: 14px;
      background: #1e3a5f; border: 1px solid #2a5a8f; color: #c0d8f0;
      padding: 7px; border-radius: 6px; cursor: pointer; font-size: 12px;
      font-family: 'Segoe UI', sans-serif; transition: background 0.15s;
    }
    .cp-reset:hover { background: #2a5a8f; }

    .basemap-btn {
      display: block; width: 100%; text-align: left;
      background: #0e2240; border: 1px solid #1e3a5f; color: #c0d8f0;
      padding: 5px 10px; border-radius: 5px; cursor: pointer;
      font-size: 12px; margin-bottom: 3px; transition: background 0.15s;
      font-family: 'Segoe UI', sans-serif;
    }
    .basemap-btn:last-child { margin-bottom: 0; }
    .basemap-btn:hover { background: #1e3a5f; }
    .basemap-btn.active { background: #1e5fa8; border-color: #4a9eff; color: #fff; }
  </style>
</head>
<body>
<header>
  <div class="logo"><svg height="36" style="display:block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 568 128"><path d="M201.1 89.8h-46l-11.9 26.5h-9.8L173 29h10.5l39.6 87.3h-10.5l-11.5-26.5zm-22.9-51.7l-19.4 43.4h38.6l-19.2-43.4zM227.4 28.3h9v55.4l38.8-30.9h13.5l-31.1 24.1 33.5 39.5h-12l-28.3-33.6-14.3 10.9v22.7h-9l-.1-88.1z" fill="#6d6e6b"></path><path d="M354.8 96.1c-3.7 11.2-13.2 22.3-34.2 22.3-26 0-34.6-18.2-34.6-33.8 0-17.7 10.9-33.7 34.6-33.7 16.4 0 35.8 7.1 35.8 35.9H295c0 13.2 9.4 24 25.5 24 15.2 0 22-5 25.2-14.7h9.1zm-7.5-16.2c-2.6-15.7-14.1-21.5-26.2-21.5-11.6 0-24.1 6-26.2 21.5h52.4zM365.3 52.8h9v14.6h.2c3.3-7.6 9.3-16.5 24.3-16.5 1.8 0 3.6.1 5.4.5v9.3c-2.7-.5-5.5-.7-8.3-.7-9.8 0-21.6 6-21.6 24.1v32.4h-9V52.8zM409.5 29.1h49.6c17.1 0 24.3 9.7 24.3 22 0 8.4-4.6 16.3-15 18.7v.2c11.5 1.7 18.5 10.1 18.5 21.4 0 18.2-15.4 24.9-28.9 24.9h-48.6V29.1zm9 37.9h35.8c12.2 0 20-3.9 20-15.5 0-10.6-7.1-14.1-17-14.1h-38.8V67zm0 41h38c11.7 0 20.5-4.7 20.5-16.6 0-12.6-7.8-16.1-18.3-16.1h-40.2V108zM494.6 29.1h47.1c13.5 0 26.3 6.7 26.3 25.2 0 16.5-10.9 25.4-30.3 25.4h-34v36.7h-9l-.1-87.3zm9.1 42.3h35c15.2 0 19.6-7 19.6-17.1 0-13.1-7.3-16.9-17.7-16.9h-36.8l-.1 34z" fill="#6d6e6b"></path><linearGradient id="a" gradientUnits="userSpaceOnUse" x1="95.178" y1="74.202" x2="118.788" y2="67.432" gradientTransform="matrix(1 0 0 -1 0 130)"><stop offset="0" stop-color="#ac6244"></stop><stop offset=".49" stop-color="#8d2700"></stop><stop offset=".63" stop-color="#8f2a04"></stop><stop offset=".75" stop-color="#94340f"></stop><stop offset=".87" stop-color="#9c4421"></stop><stop offset=".98" stop-color="#a85a3a"></stop><stop offset="1" stop-color="#aa5e3f"></stop></linearGradient><path d="M119.8 53.5c.2-1.5.4-2.8.6-4v.1c-.7 4-4.4 1.8-5.9.8-7.7-5.1-19.5-10.1-17.1 3.5 2.2 12.7 18 18.3 17.8 21.1 2-6.8 3.5-13.8 4.5-20.8l.1-.7z" fill="url(#a)"></path><path d="M27.6 6.6c-.5.8.3 1.7 1.4 2.8 3.5-2.9.1-5.2-1.3-3l-.1.2zM24.2 31.4c-1.4-2.5-2.7-5.5-2.2-8.4-1.6 1.8-3 3.8-4 6-.5 1-.5 2.1 6.2 2.4zM15.4 43.1c-.3-2.3-2.5-3.5-3.2-2-.4.8-.2 2.6 3 3.9.2-.6.3-1.2.2-1.9z" fill="#54284e"></path><linearGradient id="b" gradientUnits="userSpaceOnUse" x1="-310.911" y1="-171.789" x2="-254.041" y2="-190.262" gradientTransform="scale(1 -1) rotate(-3.35 2355.292 -5724.007)"><stop offset="0" stop-color="#8e006d"></stop><stop offset=".04" stop-color="#ad006d"></stop><stop offset=".08" stop-color="#c4006d"></stop><stop offset=".11" stop-color="#d2006d"></stop><stop offset=".14" stop-color="#d7006d"></stop><stop offset=".17" stop-color="#d80670"></stop><stop offset=".2" stop-color="#db1778"></stop><stop offset=".24" stop-color="#e13386"></stop><stop offset=".28" stop-color="#e95a9a"></stop><stop offset=".32" stop-color="#f28bb2"></stop><stop offset=".33" stop-color="#f391b6"></stop><stop offset=".34" stop-color="#f498bb"></stop><stop offset=".37" stop-color="#f49abc"></stop><stop offset=".41" stop-color="#f27bb0"></stop><stop offset=".48" stop-color="#ef469b"></stop><stop offset=".54" stop-color="#ec208c"></stop><stop offset=".59" stop-color="#eb0983"></stop><stop offset=".62" stop-color="#ea0080"></stop><stop offset=".69" stop-color="#e0007e"></stop><stop offset=".81" stop-color="#c60079"></stop><stop offset=".96" stop-color="#9b0070"></stop><stop offset="1" stop-color="#8e006d"></stop></linearGradient><path d="M71.4 48c-1.8-2.2-3.9-4.1-6.4-5.5-11-6.8-29.8-10.9-37.7-11-1.2 0-2.2 0-3.1-.1-6.7-.3-6.7-1.4-6.2-2.4 1-2.2 2.4-4.3 4.1-6 4.8-5.1 10.9-6.9 15.7-8.2C44 13 54.5 7.1 45.3 2.3s-14.7-.6-15.7.8c-.8 1.1-1.4 2.3-2 3.5l.1-.2c1.5-2.2 4.8.1 1.3 3l-.2.1c-3.9 3.1-8.1 10.2-10.4 15.4-3.2 7.1-6.3 16.2-6.3 16.2.8-1.5 2.9-.3 3.2 2 .1.6 0 1.3-.2 1.9-.5 1.4-1.1 2.7-1.9 3.9-3.2 5.5 1.9 10.2 6.6 11.1 4.1.8 27.2-1.2 35.5-2.2 1.3-.2 2.2-.3 2.7-.4 3.4-.6 18.2-3 13.4-9.4z" fill="url(#b)"></path><path d="M1.8 79.8v-.2.2z" fill="#0d361c"></path><linearGradient id="c" gradientUnits="userSpaceOnUse" x1="1.764" y1="49.34" x2="17.5" y2="49.34" gradientTransform="matrix(1 0 0 -1 0 130)"><stop offset="0" stop-color="#003824"></stop><stop offset="1" stop-color="#00822c"></stop></linearGradient><path d="M3.2 87c2.9 2.2 7.8 1.4 14.3-.1C9.8 78.8 7.2 72.6 4.4 73c-1.5.2-2.2 4.2-2.6 6.7-.2 4.4.4 6.6 1.4 7.3z" fill="url(#c)"></path><linearGradient id="d" gradientUnits="userSpaceOnUse" x1="-316.529" y1="-243.401" x2="-260.452" y2="-275.779" gradientTransform="scale(1 -1) rotate(-3.35 2355.292 -5724.007)"><stop offset="0" stop-color="#003824"></stop><stop offset=".51" stop-color="#109840"></stop><stop offset=".72" stop-color="#0d943c"></stop><stop offset=".93" stop-color="#048831"></stop><stop offset="1" stop-color="#00822c"></stop></linearGradient><path d="M5.3 102.5l-.7-.2c1.9 3.8 4.2 7.4 6.9 10.7 15.4 18.9 46.1 15.6 53.2 13.1s1.6-7.6-2.7-10.1c-2.5-1.5-9.4-4.1-18.3-9.2-12.6-.3-27.8-1.4-38.4-4.3z" fill="url(#d)"></path><linearGradient id="e" gradientUnits="userSpaceOnUse" x1="-289.899" y1="-194.116" x2="-210.154" y2="-210.997" gradientTransform="scale(1 -1) rotate(-3.35 2355.292 -5724.007)"><stop offset=".16" stop-color="#8d2719"></stop><stop offset=".22" stop-color="#9b391c"></stop><stop offset=".34" stop-color="#bf6722"></stop><stop offset=".51" stop-color="#f5ad2c"></stop><stop offset=".65" stop-color="#f5ad2c"></stop><stop offset=".69" stop-color="#f2a32c"></stop><stop offset=".77" stop-color="#e98a2a"></stop><stop offset=".86" stop-color="#dc6029"></stop><stop offset=".93" stop-color="#d03c27"></stop></linearGradient><path d="M108.8 33.1c-11 .1-22 1.7-32.7 4.6-3.9 1-7.6 2.6-11 4.8v.1c2.4 1.4 4.6 3.3 6.3 5.5 4.8 6.4-10 8.8-13.5 9.5-.5.1-1.4.2-2.7.4-.2 1.5-.2 3 0 4.5.4 3.3-1.1 6.7-4.8 7.5s-20.7 5.3-20.8 9c.1 1.8.6 3.5 1.5 5 2.1-.4 4.4-.8 6.7-1.1 16.4-2.1 47.3-6.3 49.2.8 8.6-4 13.9-8.7 17.3-10.3 4-1.9 10 3.8 10.8 1.7.2-2.8-15.7-8.4-17.8-21.1-2.3-13.6 9.5-8.6 17.1-3.5 1.5 1 5.2 3.2 5.9-.8v-.1c.9-6.3.7-6.7 1.1-10.8.5-5-7.9-5.9-12.6-5.7z" fill="url(#e)"></path><linearGradient id="f" gradientUnits="userSpaceOnUse" x1="1.482" y1="49.064" x2="83.137" y2="28.71" gradientTransform="matrix(1 0 0 -1 0 130)"><stop offset="0" stop-color="#005d33"></stop><stop offset=".02" stop-color="#096339"></stop><stop offset=".06" stop-color="#237349"></stop><stop offset=".11" stop-color="#4d8d62"></stop><stop offset=".17" stop-color="#86b186"></stop><stop offset=".21" stop-color="#b2cda1"></stop><stop offset=".25" stop-color="#b2cda1"></stop><stop offset=".3" stop-color="#73bb7a"></stop><stop offset=".35" stop-color="#42ad5c"></stop><stop offset=".4" stop-color="#1ea345"></stop><stop offset=".43" stop-color="#089c38"></stop><stop offset=".46" stop-color="#009a33"></stop><stop offset=".87" stop-color="#005d33"></stop></linearGradient><path d="M37.9 82.8c-2.3.3-4.6.7-6.7 1.1-5.1 1-9.8 2.2-13.7 3-6.5 1.5-11.4 2.3-14.3.1-1-.8-1.6-3-1.4-7.3v.2C1.2 84-.1 92.6 0 96.3c.1 3.5.8 4.8 4.6 6l.7.2c10.6 2.9 25.8 4 38.5 4.3 10.9.2 19.9-.2 22.3-.6 5.1-.8 4.5-4.4 3.8-6.9-.8-2.7-1.4-4.8 2.6-5.8 5.1-1.3 14.3-5 14.8-8.7.1-.4 0-.8-.1-1.2-2-7.1-32.9-2.9-49.3-.8z" fill="url(#f)"></path></svg></div>
  <h1>Licence map</h1>
  <div class="controls">
    <button class="legend-btn active" id="toggleLicences" onclick="toggleLayer('licences')">Licences</button>
    <button class="legend-btn active" id="toggleFields"   onclick="toggleLayer('fields')">Fields</button>
    <button class="legend-btn active" id="toggleDiscoveries" onclick="toggleLayer('discoveries')">Discoveries</button>
    <button class="legend-btn" id="toggleCustomise" onclick="toggleCustomise()">&#9881; Customise</button>
  </div>
</header>
<div id="map"></div>
<div id="loading"><div class="spinner"></div><p id="loadingMsg">Loading data from Sodir...</p></div>
<div id="customise-panel" class="hidden">
  <div class="cp-header">
    <h2>Customise</h2>
    <button class="close-btn" onclick="toggleCustomise()">&#x2715;</button>
  </div>
  <div class="cp-body">

    <div class="cp-section">
      <div class="cp-section-title">Visibility</div>

      <div class="cp-row">
        <span class="cp-label">Show carbon storage licences</span>
        <label class="cp-toggle"><input type="checkbox" id="vis-carbon" onchange="toggleCarbonLicences(this.checked)"><span class="cp-slider"></span></label>
      </div>
      <div class="cp-row">
        <span class="cp-label">Show shut-down fields</span>
        <label class="cp-toggle"><input type="checkbox" id="vis-shutdown" onchange="toggleShutdown(this.checked)"><span class="cp-slider"></span></label>
      </div>
      <div class="cp-row">
        <span class="cp-label">Show other NCS fields</span>
        <label class="cp-toggle"><input type="checkbox" id="vis-otherfields" onchange="toggleOtherFields(this.checked)"><span class="cp-slider"></span></label>
      </div>
      <div class="cp-row">
        <span class="cp-label">Show other NCS discoveries</span>
        <label class="cp-toggle"><input type="checkbox" id="vis-otherdisc" onchange="toggleOtherDiscoveries(this.checked)"><span class="cp-slider"></span></label>
      </div>
    </div>

    <div class="cp-section">
      <div class="cp-section-title">Labels on map</div>
      <div class="cp-row">
        <span class="cp-label">Licence labels</span>
        <label class="cp-toggle"><input type="checkbox" id="lbl-licences" onchange="toggleLabels('licences',this.checked);toggleLabels('units',this.checked);toggleLabels('ukLicences',this.checked)"><span class="cp-slider"></span></label>
      </div>
      <div class="cp-row">
        <span class="cp-label">Field labels</span>
        <label class="cp-toggle"><input type="checkbox" id="lbl-fields" onchange="toggleLabels('fields',this.checked)"><span class="cp-slider"></span></label>
      </div>
      <div class="cp-row">
        <span class="cp-label">Office labels</span>
        <label class="cp-toggle"><input type="checkbox" id="lbl-offices" onchange="toggleLabels('offices',this.checked)"><span class="cp-slider"></span></label>
      </div>
      <div class="cp-row">
        <span class="cp-label">Discovery labels</span>
        <label class="cp-toggle"><input type="checkbox" id="lbl-discoveries" onchange="toggleLabels('discoveries',this.checked)"><span class="cp-slider"></span></label>
      </div>
    </div>

    <div class="cp-section">
      <div class="cp-section-title">Basemap</div>
      <div class="cp-basemap-grid">
        <button class="basemap-btn active" data-name="Dark"      onclick="switchBasemap(this.dataset.name)">Dark</button>
        <button class="basemap-btn"        data-name="Light"     onclick="switchBasemap(this.dataset.name)">Light</button>
        <button class="basemap-btn"        data-name="OSM"       onclick="switchBasemap(this.dataset.name)">OpenStreetMap</button>
        <button class="basemap-btn"        data-name="Satellite" onclick="switchBasemap(this.dataset.name)">Satellite</button>
        <button class="basemap-btn"        data-name="Ocean"     onclick="switchBasemap(this.dataset.name)">Ocean</button>
        <button class="basemap-btn"        data-name="NatGeo"    onclick="switchBasemap(this.dataset.name)">Nat. Geographic</button>
      </div>
    </div>

    <button class="cp-reset" onclick="resetCustomise()">&#8635; Reset to defaults</button>

    <div class="cp-section" style="margin-top:16px;border-top:1px solid #1e3a5f;padding-top:14px">
      <button class="cp-reset" style="background:#1e3a5f;width:100%;text-align:left;padding:8px 12px;border-radius:6px;color:#c0d8f0;font-size:12px;cursor:pointer;border:1px solid #2a5a8f" onclick="toggleLegend()">&#9432; Show / hide legend</button>
    </div>
  </div>
</div>

<div id="maplegend" class="hidden">
  <h3>Legend</h3>
  <div class="legend-item"><div class="legend-swatch" style="background:rgba(206,15,105,0.22);border:2px solid #ce0f69;" id="swatch-lic-op"></div>Licence – Aker BP operator</div>
  <div class="legend-item"><div class="legend-swatch" style="background:rgba(246,141,46,0.22);border:2px dashed #f68d2e;" id="swatch-lic-lh"></div>Licence – Aker BP licensee</div>
  <div class="legend-item"><div class="legend-swatch" style="background:rgba(0,207,255,0.18);border:2px solid #00cfff;"></div>UK Licence – Aker BP</div>
  <div class="legend-item"><div class="legend-swatch" style="background:rgba(0,179,115,0.55);border:2px solid #00b373;" id="swatch-fld-op"></div>Field – Aker BP operator/owner</div>
  <div class="legend-item"><div class="legend-swatch" style="background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.25);"></div>Field – shut down</div>
  <div class="legend-item"><div class="legend-swatch" style="background:rgba(0,179,115,0.10);border:1px solid #00b373;opacity:0.6;"></div>Field – other (no Aker BP interest)</div>
  <div class="legend-item"><div class="legend-swatch" style="background:rgba(255,220,0,0.7);border:2px solid #ffdc00;border-radius:50%;width:14px;height:14px;"></div>Discovery – Aker BP licence</div>
  <div class="legend-item"><div class="legend-swatch" style="background:rgba(255,220,0,0.2);border:1px solid #ffdc00;border-radius:50%;width:14px;height:14px;"></div>Discovery – other</div>
  <div class="legend-item"><div class="legend-swatch" style="background:rgba(255,255,255,0.9);border:2px solid #4a9eff;border-radius:50%;"></div>Aker BP office</div>
</div>

<div id="sidebar" class="hidden">
  <div class="sidebar-header"><h2 id="sidebarTitle">Info</h2><button class="close-btn" onclick="closeSidebar()">&#x2715;</button></div>
  <div class="sidebar-content" id="sidebarContent"></div>
</div>
<div id="statsbar">
  <div class="stat"><div class="stat-dot dot-licence"></div><span class="stat-label">Licences:</span><span class="stat-count" id="licenceCount">-</span></div>
  <div class="stat"><div class="stat-dot dot-field"></div><span class="stat-label">Fields:</span><span class="stat-count" id="fieldCount">-</span></div>
  <div class="stat"><div class="stat-dot" style="background:#ffdc00"></div><span class="stat-label">Discoveries:</span><span class="stat-count" id="discoveryCount">-</span></div>
</div>

<div id="errormsg" class="hidden"></div>

<script>
const BASE      = 'https://factmaps.sodir.no/api/rest/services/DataService/Data/MapServer';
const AKERBP_ID = 28544099;
const NSTA_BASE = 'https://services-eu1.arcgis.com/OZMfUznmLTnWccBc/arcgis/rest/services/UKCS%20offshore%20petroleum%20licences%20WGS84/FeatureServer';

// Farger
let C_LIC_OP  = '#ce0f69';
let C_LIC_LH  = '#f68d2e';
let C_UNIT_OP = '#ce0f69';
let C_UNIT_LH = '#f68d2e';
let C_FLD_OP  = '#00b373';
let C_FLD_OW  = '#00b373';
let C_FLD_SD  = '#ffffff';
const C_DISC   = '#ffdc00';  // yellow – discovery  // hvit dim – felt, shut down

// Label visibility state – declared early so renderOffices IIFE can access it
const labelState = { licences: false, units: false, fields: false, offices: false, discoveries: false, ukLicences: false };

// Feature visibility flags – declared early so render functions can always read them
let showCarbonLicences = false;
let showShutdown = false;
let showOtherFields = false;
let showOtherDiscoveries = false;

const map = L.map('map', { zoomControl: true }).setView([68, 10], 5);

const BASEMAPS = {
  'Dark':        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',   { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19 }),
  'Light':       L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',  { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19 }),
  'OSM':         L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',                  { attribution: '&copy; OpenStreetMap contributors', maxZoom: 19 }),
  'Satellite':   L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri &copy; USGS', maxZoom: 19 }),
  'Ocean':       L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri &copy; GEBCO &copy; NOAA', maxZoom: 13 }),
  'NatGeo':      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri &copy; National Geographic', maxZoom: 16 }),
};

let currentBasemap = BASEMAPS['Dark'];
currentBasemap.addTo(map);

const LIGHT_BASEMAPS = new Set(['Light', 'OSM', 'NatGeo']);
async function switchBasemap(name) {
  if (currentBasemap) map.removeLayer(currentBasemap);
  currentBasemap = BASEMAPS[name];
  currentBasemap.addTo(map);
  const pane = map.getPane('tilePane');
  if (pane) pane.style.zIndex = 200;
  document.querySelectorAll('.basemap-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.name === name)
  );
  document.body.classList.toggle('basemap-light', LIGHT_BASEMAPS.has(name));
}

// Lag-rekkefølge nederst til øverst: lisenser → units → felt
// Leaflet-paner for garantert lag-rekkefølge (høyere z-index = øverst)
map.createPane('discoveryPane'); map.getPane('discoveryPane').style.zIndex = 425;
map.createPane('officePane');  map.getPane('officePane').style.zIndex  = 430;
map.createPane('licencePane'); map.getPane('licencePane').style.zIndex = 400;
map.createPane('unitPane');    map.getPane('unitPane').style.zIndex    = 410;
map.createPane('fieldPane');   map.getPane('fieldPane').style.zIndex   = 420;

const discoveryLayer = L.layerGroup().addTo(map);
const officeLayer  = L.layerGroup().addTo(map);
const licenceLayer = L.layerGroup().addTo(map);
const unitLayer    = L.layerGroup().addTo(map);
const fieldLayer   = L.layerGroup().addTo(map);
const ukLicenceLayer = L.layerGroup().addTo(map);

let showFields=true, showLicences=true, showUnits=true, showDiscoveries=true;
let showUKLicences=true;
function toggleLayer(t) {
  if(t==='fields')      { showFields=!showFields;           document.getElementById('toggleFields').classList.toggle('active',showFields);           showFields      ?map.addLayer(fieldLayer)     :map.removeLayer(fieldLayer);      }
  if(t==='licences')    { showLicences=!showLicences; showUnits=showLicences; showUKLicences=showLicences; document.getElementById('toggleLicences').classList.toggle('active',showLicences); showLicences ? (map.addLayer(licenceLayer), map.addLayer(unitLayer), map.addLayer(ukLicenceLayer)) : (map.removeLayer(licenceLayer), map.removeLayer(unitLayer), map.removeLayer(ukLicenceLayer)); }
  if(t==='discoveries') { showDiscoveries=!showDiscoveries; document.getElementById('toggleDiscoveries').classList.toggle('active',showDiscoveries); showDiscoveries ?map.addLayer(discoveryLayer):map.removeLayer(discoveryLayer); }
}
function toggleLegend() { document.getElementById('maplegend').classList.toggle('hidden'); }
let showOffices=true;
function closeSidebar()  { document.getElementById('sidebar').classList.add('hidden'); }
function showError(msg)  { const el=document.getElementById('errormsg'); el.textContent=msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),12000); }
function setLoading(msg) { const el=document.getElementById('loading'); msg ? (document.getElementById('loadingMsg').textContent=msg, el.classList.remove('hidden')) : el.classList.add('hidden'); }

// ─── API ───────────────────────────────────────────────────────────────────

async function queryAll(layerId, where, outFields, withGeo=false) {
  let all=[], offset=0;
  while(true) {
    const params = {
      where, outFields, f:'json',
      returnGeometry: withGeo ? 'true' : 'false',
      resultRecordCount: '2000',
      resultOffset: String(offset),
      ...(withGeo ? {outSR:'4326'} : {})
    };
    // Use POST to avoid URL-length CORS issues on large IN-lists
    const body = new URLSearchParams(params);
    let d;
    try {
      const resp = await fetch(`${BASE}/${layerId}/query`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
      });
      d = await resp.json();
    } catch(postErr) {
      // Fallback to GET for layers that don't accept POST
      const qs = new URLSearchParams(params);
      const resp = await fetch(`${BASE}/${layerId}/query?${qs}`);
      d = await resp.json();
    }
    if(d.error) throw new Error(`Lag ${layerId}: ${d.error.message}`);
    const rows = d.features||[];
    all = all.concat(rows);
    if(!d.exceededTransferLimit || rows.length === 0) break;
    offset += rows.length;
  }
  return all;
}

// GET-only variant for lag som ikke støtter POST (f.eks. lag 3300)
// Bruker exceededTransferLimit for å håndtere serverens egne sidestørrelser
async function queryAllGET(layerId, where, outFields, withGeo=false) {
  let all=[], offset=0;
  while(true) {
    const qs = new URLSearchParams({
      where, outFields, f:'json',
      returnGeometry: withGeo ? 'true' : 'false',
      resultRecordCount: '500',
      resultOffset: String(offset),
      ...(withGeo ? {outSR:'4326'} : {})
    });
    const d = await (await fetch(`${BASE}/${layerId}/query?${qs}`)).json();
    if(d.error) throw new Error(`Lag ${layerId}: ${d.error.message}`);
    const rows = d.features||[];
    all = all.concat(rows);
    // Stopp hvis serveren ikke sier det er mer, eller ingen rader
    if(!d.exceededTransferLimit || rows.length === 0) break;
    offset += rows.length;
  }
  return all;
}

// GeoJSON-konvertering fra ESRI JSON
function toGeoJSON(esriFeatures) {
  return {
    type: 'FeatureCollection',
    features: esriFeatures.map(f => ({
      type: 'Feature',
      geometry: esriGeom(f.geometry),
      properties: f.attributes
    })).filter(f => f.geometry)
  };
}

function esriGeom(g) {
  if(!g) return null;
  if(g.rings) {
    if(g.rings.length === 0) return null;
    if(g.rings.length === 1) return { type:'Polygon', coordinates:g.rings };
    return { type:'MultiPolygon', coordinates:g.rings.map(r=>[r]) };
  }
  if(g.x !== undefined) return { type:'Point', coordinates:[g.x, g.y] };
  if(g.type) return g;
  return null;
}

function fmtPct(v) { return (v==null||v==='')?null: parseFloat(v).toFixed(1)+' %'; }

function isShutDown(status) {
  if(!status) return false;
  const s = status.toLowerCase();
  return s.includes('shut') || s.includes('abandon') || s.includes('closed') || s.includes('cease');
}

// ─── FAKTABOKS ────────────────────────────────────────────────────────────

function showSidebar(title, sections) {
  document.getElementById('sidebarTitle').textContent = title;
  let html = '';
  for(const s of sections) {
    if(s.heading) html += `<div class="info-section-title">${s.heading}</div>`;
    for(const [label, value] of (s.rows||[])) {
      if(value===null||value===undefined||value==='') continue;
      html += `<div class="info-row"><span class="info-label">${label}</span><span class="info-value">${value}</span></div>`;
    }
  }
  document.getElementById('sidebarContent').innerHTML = html;
  document.getElementById('sidebar').classList.remove('hidden');
}

function polyStyle(col, dashed, dimmed) {
  return {
    color: col,
    weight: dimmed ? 1 : 1.5,
    fillColor: col,
    fillOpacity: dimmed ? 0.04 : 0.20,
    dashArray: dashed ? '7 4' : null,
    opacity: dimmed ? 0.30 : 1.0
  };
}

// ─── MAIN LOAD ────────────────────────────────────────────────────────────

async function loadData() {
  try {

    // ── 1. Lisensoperatørroller (lag 3008) ──────────────────────────────
    // Aker BP er operatør på 130 lisenser (prlOperDateValidTo IS NULL)
    setLoading('Fetching licence operator roles...');
    const licOperRows = await queryAll(3008,
      `cmpNpdidCompany = ${AKERBP_ID} AND prlOperDateValidTo IS NULL`,
      'prlNpdidLicence');
    const operatorLicIds = new Set(licOperRows.map(f => f.attributes.prlNpdidLicence));
    console.log('Lisensoperatørandeler:', operatorLicIds.size);

    // ── 2. Lisenserveiandeler for Aker BP (lag 3007) ─────────────────────
    // prlLicenseeInterest = Aker BPs andel, prlLicenseeDateValidTo IS NULL = nåværende
    setLoading('Fetching licence ownership shares...');
    const licShareRows = await queryAll(3007,
      `cmpNpdidCompany = ${AKERBP_ID} AND prlLicenseeDateValidTo IS NULL`,
      'prlNpdidLicence,prlLicenseeInterest');
    const licShareMap = {}; // prlNpdidLicence → Aker BPs andel
    licShareRows.forEach(f => { licShareMap[f.attributes.prlNpdidLicence] = f.attributes.prlLicenseeInterest; });

    // ── 3. Alle medlisenshavers andeler per lisens (lag 3007) ────────────
    // Hent alle nåværende lisenshavere for Aker BPs lisenser
    setLoading('Fetching all licensees...');
    // Vi trenger lisens-IDene fra steg 1+2
    const allLicIds = [...new Set([...operatorLicIds, ...Object.keys(licShareMap).map(Number)])];
    let allLicenseeRows = [];
    for(let i=0; i<allLicIds.length; i+=500) {
      const batch = allLicIds.slice(i,i+500).join(',');
      const rows = await queryAll(3007,
        `prlNpdidLicence IN (${batch}) AND prlLicenseeDateValidTo IS NULL`,
        'prlNpdidLicence,cmpLongName,prlLicenseeInterest,prlLicenseeSdfi');
      allLicenseeRows = allLicenseeRows.concat(rows);
    }
    // Bygg map: prlNpdidLicence → [ {company, share, sdfi} ]
    const licLicenseeMap = {};
    allLicenseeRows.forEach(f => {
      const a = f.attributes;
      if(!licLicenseeMap[a.prlNpdidLicence]) licLicenseeMap[a.prlNpdidLicence] = [];
      licLicenseeMap[a.prlNpdidLicence].push({ company: a.cmpLongName, share: a.prlLicenseeInterest, sdfi: a.prlLicenseeSdfi });
    });

    // ── 4. Lisensgeometrier (lag 3000) ────────────────────────────────────
    // Lag 3000 har én rad per lisenshaver per lisens.
    // Vi henter geometri for ALLE lisenser der Aker BP er involvert:
    //   a) lisenser der Aker BP er operatør (fra operatorLicIds)
    //   b) lisenser der Aker BP er lisenshaver (fra licShareMap)
    // Kombinerer disse og henter geometri via prlNpdidLicence IN (...)
    setLoading('Loading licence geometries...');
    const allInvolvedLicIds = [...new Set([...operatorLicIds, ...Object.keys(licShareMap).map(Number)])];
    console.log(`Totalt involverte lisenser: ${allInvolvedLicIds.length} (${operatorLicIds.size} operatør, ${Object.keys(licShareMap).length} med andel)`);
    let licGeoRows = [];
    // Hent i bolker på 100 for å unngå for store queries
    for(let i=0; i<allInvolvedLicIds.length; i+=100) {
      const batch = allInvolvedLicIds.slice(i,i+100).join(',');
      const rows = await queryAll(3000,
        `prlNpdidLicence IN (${batch})`,
        'prlNpdidLicence,prlName,prlMainArea,prlStatus,prlPhaseCurrent,prlCurrentArea,prlFactPageUrl',
        true);
      licGeoRows = licGeoRows.concat(rows);
    }
    // Dedupliser (lag 3000 kan ha flere rader per lisens – ta første per prlNpdidLicence)
    const seenLicIds = new Set();
    const dedupedLicRows = licGeoRows.filter(f => {
      const id = f.attributes.prlNpdidLicence;
      if(seenLicIds.has(id)) return false;
      seenLicIds.add(id);
      return true;
    });
    const licGeo = toGeoJSON(dedupedLicRows);

    // Berik med operatørstatus og andeler
    licGeo.features.forEach(f => {
      const p = f.properties;
      p.isOperator    = operatorLicIds.has(p.prlNpdidLicence);
      p._myShare      = licShareMap[p.prlNpdidLicence] ?? null;
      p._allLicensees = licLicenseeMap[p.prlNpdidLicence] || [];
    });
    console.log(`Lisenser: ${licGeo.features.length} (${[...licGeo.features].filter(f=>f.properties.isOperator).length} operatør, ${[...licGeo.features].filter(f=>!f.properties.isOperator).length} lisenshaver)`);

    // ── 5. Unit-operatørroller (lag 3302) ─────────────────────────────────
    // baaOperatorDateValidTo IS NULL = nåværende
    setLoading('Fetching BAA operator roles...');
    const unitOperRows = await queryAll(3302,
      `cmpNpdidCompany = ${AKERBP_ID} AND baaOperatorDateValidTo IS NULL`,
      'baaNpdidBsnsArrArea,baaName');
    const unitOperIds = new Set(unitOperRows.map(f => f.attributes.baaNpdidBsnsArrArea));
    console.log('Unit-operatørroller:', unitOperIds.size);

    // ── 6. Unit-eierandeler for Aker BP (lag 3304) ───────────────────────
    // baaLicenseeDateValidTo IS NULL = nåværende, baaLicenseeInterest = andel
    setLoading('Fetching BAA ownership shares...');
    const unitShareRows = await queryAll(3304,
      `cmpNpdidCompany = ${AKERBP_ID} AND baaLicenseeDateValidTo IS NULL`,
      'baaNpdidBsnsArrArea,baaLicenseeInterest');
    const unitMyShareMap = {}; // baaNpdidBsnsArrArea → Aker BPs andel
    unitShareRows.forEach(f => { unitMyShareMap[f.attributes.baaNpdidBsnsArrArea] = f.attributes.baaLicenseeInterest; });
    console.log('Unit-eierandeler:', Object.keys(unitMyShareMap).length);

    // ── 7. Alle medlisenshavers andeler per unit (lag 3304) ──────────────
    const allUnitIds = [...new Set([...unitOperIds, ...Object.keys(unitMyShareMap).map(Number)])];
    let allUnitLicenseeRows = [];
    if(allUnitIds.length > 0) {
      const rows = await queryAll(3304,
        `baaNpdidBsnsArrArea IN (${allUnitIds.join(',')}) AND baaLicenseeDateValidTo IS NULL`,
        'baaNpdidBsnsArrArea,cmpLongName,baaLicenseeInterest,baaLicenseeSdfi');
      allUnitLicenseeRows = rows;
    }
    const unitLicenseeMap = {}; // baaNpdidBsnsArrArea → [ {company, share} ]
    allUnitLicenseeRows.forEach(f => {
      const a = f.attributes;
      if(!unitLicenseeMap[a.baaNpdidBsnsArrArea]) unitLicenseeMap[a.baaNpdidBsnsArrArea] = [];
      unitLicenseeMap[a.baaNpdidBsnsArrArea].push({ company: a.cmpLongName, share: a.baaLicenseeInterest, sdfi: a.baaLicenseeSdfi });
    });

    // ── 8. Unit-geometrier (lag 3300) ─────────────────────────────────────
    // Lag 3300: cmpNpdidCompany-søk fungerer (bekreftet i debug), IN() feiler.
    // Strategi: hent alle units via cmpNpdidCompany (gir operatørenheter),
    // og suppler med enkelt-ID-oppslag for units fra eierandelslisten.
    setLoading('Loading BAA geometries...');
    const unitGeoMap = {}; // baaNpdidBsnsArrArea → esri feature

    // Lag 3300 godtar ikke resultRecordCount/resultOffset – bruk direkte fetch
    // og paginer manuelt via exceededTransferLimit
    async function fetchBaaPage(where, outFields, offset) {
      const qs = new URLSearchParams({
        where, outFields, f: 'json', returnGeometry: 'true', outSR: '4326'
      });
      if(offset > 0) qs.set('resultOffset', String(offset));
      const d = await (await fetch(`${BASE}/3300/query?${qs}`)).json();
      return d;
    }

    // a) Hent alle units der Aker BP er nåværende operatørselskap
    try {
      let offset = 0;
      while(true) {
        const d = await fetchBaaPage(`cmpNpdidCompany = ${AKERBP_ID}`,
          'baaNpdidBsnsArrArea,baaName,baaKind,baaActive,baaFactPageUrl', offset);
        if(d.error) { console.error('Lag 3300 feil:', d.error.message); break; }
        const rows = d.features || [];
        console.log(`Lag 3300 side offset=${offset}: ${rows.length} rader, exceededTransferLimit=${d.exceededTransferLimit}`);
        rows.forEach(r => { unitGeoMap[r.attributes.baaNpdidBsnsArrArea] = r; });
        if(!d.exceededTransferLimit || rows.length === 0) break;
        offset += rows.length;
      }
    } catch(e) { console.error('Unit geo cmpNpdidCompany FEIL:', e.message); }

    // b) Hent evt. manglende units (fra eierandelslisten) enkeltvis
    const missingUnitIds = allUnitIds.filter(id => !unitGeoMap[id]);
    for(const id of missingUnitIds) {
      try {
        const d = await fetchBaaPage(`baaNpdidBsnsArrArea = ${id}`,
          'baaNpdidBsnsArrArea,baaName,baaKind,baaActive,baaFactPageUrl', 0);
        if(!d.error) (d.features||[]).forEach(r => { unitGeoMap[r.attributes.baaNpdidBsnsArrArea] = r; });
      } catch(e) { console.warn(`Unit geo id=${id}:`, e.message); }
    }

    const unitGeoRows = Object.values(unitGeoMap);
    console.log('Unit geo rader fra API:', unitGeoRows.length);
    // Debug: sjekk geometritype på første rad
    if(unitGeoRows.length > 0) {
      const g = unitGeoRows[0].geometry;
      console.log('Første unit geometri:', g ? `type=${g.type||'?'}, rings=${g.rings ? g.rings.length : 'n/a'}, paths=${g.paths ? g.paths.length : 'n/a'}` : 'NULL');
      console.log('Første unit attrs:', JSON.stringify(unitGeoRows[0].attributes));
    }
    const unitGeo = toGeoJSON(unitGeoRows);
    console.log('Unit GeoJSON features etter konvertering:', unitGeo.features.length);
    unitGeo.features.forEach(f => {
      const p = f.properties;
      p.isOperator     = unitOperIds.has(p.baaNpdidBsnsArrArea);
      p._myShare       = unitMyShareMap[p.baaNpdidBsnsArrArea] ?? null;
      p._allLicensees  = unitLicenseeMap[p.baaNpdidBsnsArrArea] || [];
    });
    console.log(`Units: ${unitGeo.features.length} (${[...unitGeo.features].filter(f=>f.properties.isOperator).length} operatør)`);

    // ── 9. Felt-operatørroller (lag 7110) ─────────────────────────────────
    setLoading('Fetching field operator roles...');
    const fldOperRows = await queryAll(7110,
      `cmpNpdidCompany = ${AKERBP_ID} AND fldOperatorTo IS NULL`,
      'fldNpdidField');
    const operatorFieldIds = new Set(fldOperRows.map(f => f.attributes.fldNpdidField));

    // ── 10. Felt-eierandeler for Aker BP (lag 7108) ───────────────────────
    // fldLicenseeTo IS NULL = nåværende, fldCompanyShare = Aker BPs andel
    setLoading('Fetching field ownership shares...');
    const fldShareRows = await queryAll(7108,
      `cmpNpdidCompany = ${AKERBP_ID} AND fldLicenseeTo IS NULL`,
      'fldNpdidField,fldCompanyShare,fldOwnerKind,fldOwnerName');
    // Bygg map: fldNpdidField → Aker BPs andel (summer per felt hvis flere rader)
    const fldMyShareMap = {};
    fldShareRows.forEach(f => {
      const a = f.attributes;
      if(!fldMyShareMap[a.fldNpdidField]) fldMyShareMap[a.fldNpdidField] = { total: 0, owners: [] };
      fldMyShareMap[a.fldNpdidField].total += parseFloat(a.fldCompanyShare)||0;
      fldMyShareMap[a.fldNpdidField].owners.push({ kind: a.fldOwnerKind, name: a.fldOwnerName, share: a.fldCompanyShare });
    });

    // ── 11. Alle medlisenshavers andeler per felt (lag 7108) ─────────────
    // Dette gir oss eierstruktur og eventuelle unit-koblinger
    setLoading('Fetching all field licensees...');
    const allFldIds = [...new Set([...operatorFieldIds, ...Object.keys(fldMyShareMap).map(Number)])];
    let allFldLicenseeRows = [];
    for(let i=0; i<allFldIds.length; i+=500) {
      const batch = allFldIds.slice(i,i+500).join(',');
      const rows = await queryAll(7108,
        `fldNpdidField IN (${batch}) AND fldLicenseeTo IS NULL`,
        'fldNpdidField,cmpLongName,fldCompanyShare,fldOwnerKind,fldOwnerName,fldSdfiShare');
      allFldLicenseeRows = allFldLicenseeRows.concat(rows);
    }
    // Bygg map: fldNpdidField → [ {company, share, ownerKind, ownerName} ]
    const fldLicenseeMap = {};
    allFldLicenseeRows.forEach(f => {
      const a = f.attributes;
      if(!fldLicenseeMap[a.fldNpdidField]) fldLicenseeMap[a.fldNpdidField] = [];
      fldLicenseeMap[a.fldNpdidField].push({
        company:   a.cmpLongName,
        share:     a.fldCompanyShare,
        ownerKind: a.fldOwnerKind,
        ownerName: a.fldOwnerName,
        sdfi:      a.fldSdfiShare
      });
    });

    // ── 12. Feltgeometrier (lag 7100) ─────────────────────────────────────
    setLoading('Loading field geometries...');
    let fldGeoRows = [];
    for(let i=0; i<allFldIds.length; i+=500) {
      const batch = allFldIds.slice(i,i+500).join(',');
      const rows = await queryAll(7100,
        `fldNpdidField IN (${batch})`,
        'fldNpdidField,fldName,fldMainArea,fldCurrentActivitySatus,fldHcType,fldDiscoveryYear,fldOwnerName,fldFactPageUrl',
        true);
      fldGeoRows = fldGeoRows.concat(rows);
    }
    const fieldGeo = toGeoJSON(fldGeoRows);
    fieldGeo.features.forEach(f => {
      const p = f.properties;
      p.isOperator    = operatorFieldIds.has(p.fldNpdidField);
      p._myShare      = fldMyShareMap[p.fldNpdidField] ?? null;
      p._allLicensees = fldLicenseeMap[p.fldNpdidField] || [];
      p._shutDown     = isShutDown(p.fldCurrentActivitySatus);
    });
    console.log(`Felt: ${fieldGeo.features.length} (${[...fieldGeo.features].filter(f=>f.properties.isOperator).length} operatør, ${[...fieldGeo.features].filter(f=>f.properties._shutDown).length} shut down)`);

    // ── 13. Render ────────────────────────────────────────────────────────
    window._licGeo   = licGeo;
    window._unitGeo  = unitGeo;
    window._fieldGeo = fieldGeo;
    renderLicences(licGeo);
    renderUnits(unitGeo);
    renderFields(fieldGeo);

    document.getElementById('licenceCount').textContent = licGeo.features.length;
    // unitCount element removed from UI
    document.getElementById('fieldCount').textContent   = fieldGeo.features.length;

    // ── 14. Discoveries ───────────────────────────────────────────────────
    setLoading('Loading Aker BP discoveries...');
    await loadAkerbpDiscoveries(licGeo);

    // UK-lisenser (ikke-blokkerende — eget API)
    loadUKLicences().catch(e => console.warn('UK licences failed:', e));

    // Zoom til portefølje
    const allF = [...licGeo.features, ...unitGeo.features, ...fieldGeo.features];
    if(allF.length > 0) {
      try {
        const bounds = L.geoJSON({type:'FeatureCollection',features:allF}).getBounds();
        if(bounds.isValid()) map.fitBounds(bounds, {padding:[50,50]});
      } catch(e) {}
    }
    setLoading(null);

  } catch(err) {
    console.error(err);
    setLoading(null);
    showError('Error: ' + err.message);
  }
}

// ─── RENDER ───────────────────────────────────────────────────────────────

function renderLicences(geojson) {
  if (!geojson) return;
  licenceLayer.clearLayers();
  L.geoJSON(geojson, {
    pane: 'licencePane',
    style(f) {
      const col = f.properties.isOperator ? C_LIC_OP : C_LIC_LH;
      return polyStyle(col, !f.properties.isOperator, false);
    },
    onEachFeature(feature, layer) {
      const p   = feature.properties;
      const col  = p.isOperator ? C_LIC_OP : C_LIC_LH;
      const role = p.isOperator ? 'Operator' : 'Licensee';
      const myShare = fmtPct(p._myShare);

      layer.on('mouseover', () => layer.setStyle({fillOpacity:0.42, weight:2.5}));
      layer.on('mouseout',  () => layer.setStyle(polyStyle(col, !p.isOperator, false)));
      layer.on('click', () => {
        // Bygg lisenshaver-tabell
        const lhRows = p._allLicensees.length > 0
          ? p._allLicensees
              .sort((a,b) => (b.share||0)-(a.share||0))
              .map(l => [l.company||'?', fmtPct(l.share) + (l.sdfi ? ` (SDFI: ${fmtPct(l.sdfi)})` : '')])
          : [['No data available', null]];
        showSidebar('Licence: ' + (p.prlName||'?'), [
          { rows: [
            ['Licence no.', p.prlName],
            ['Aker BP role', `<span style="color:${col}">${role}</span>`],
            ['Aker BP share', myShare],
            ['Area', p.prlMainArea],
            ['Status', p.prlStatus],
            ['Phase', p.prlPhaseCurrent],
            ['Area (km²)', p.prlCurrentArea],
          ]},
          { heading: 'All licensees', rows: lhRows },
          { heading: 'Links', rows: [
            ['Sodir', p.prlFactPageUrl ? `<a href="${p.prlFactPageUrl}" target="_blank" style="color:#4a9eff">Open &#x2197;</a>` : null],
          ]}
        ]);
      });
      if(p.prlName) {
        if(labelState.licences) {
          layer.bindTooltip(p.prlName,
            {permanent:true, direction:'center', className:'map-label map-label-licence', offset:[0,0]}
          );
        } else {
          const role = p.isOperator ? 'Operator' : 'Licensee';
          const myShare = p._myShare ? fmtPct(p._myShare) : null;
          layer.bindTooltip(
            `<strong>${p.prlName}</strong><br><span style="color:${col};font-size:11px">${role}${myShare ? ' · ' + myShare : ''}</span>`,
            {sticky:true, className:'tooltip-dark'}
          );
        }
      }
    }
  }).addTo(licenceLayer);
}

function renderUnits(geojson) {
  if (!geojson) return;
  unitLayer.clearLayers();
  // EXL-enheter er karbonlagring — filtrer bort med mindre showCarbonLicences er på
  const filtered = showCarbonLicences ? geojson : {
    type: 'FeatureCollection',
    features: geojson.features.filter(f => !String(f.properties.baaName || '').toUpperCase().startsWith('EXL'))
  };
  L.geoJSON(filtered, {
    pane: 'unitPane',
    style(f) {
      const col = f.properties.isOperator ? C_UNIT_OP : C_UNIT_LH;
      // Units: tykkere kant og høyere opacity enn lisenser for å skille seg ut
      return {
        color: col, weight: 2.5, fillColor: col,
        fillOpacity: 0.30, dashArray: f.properties.isOperator ? null : '7 4',
        pane: 'unitPane'
      };
    },
    onEachFeature(feature, layer) {
      const p   = feature.properties;
      const col  = p.isOperator ? C_UNIT_OP : C_UNIT_LH;
      const role = p.isOperator ? 'Operator' : 'Licensee';
      const myShare = fmtPct(p._myShare);

      const unitBaseStyle = { color:col, weight:2.5, fillColor:col, fillOpacity:0.30, dashArray: p.isOperator ? null : '7 4' };
      layer.on('mouseover', () => layer.setStyle({fillOpacity:0.55, weight:3.5}));
      layer.on('mouseout',  () => layer.setStyle(unitBaseStyle));
      layer.on('click', () => {
        const lhRows = p._allLicensees.length > 0
          ? p._allLicensees
              .sort((a,b) => (b.share||0)-(a.share||0))
              .map(l => [l.company||'?', fmtPct(l.share) + (l.sdfi ? ` (SDFI: ${fmtPct(l.sdfi)})` : '')])
          : [['No data available', null]];
        showSidebar('BAA: ' + (p.baaName||'?'), [
          { rows: [
            ['Name', p.baaName],
            ['Type', p.baaKind],
            ['Aker BP role', `<span style="color:${col}">${role}</span>`],
            ['Aker BP share', myShare],
            ['Active', p.baaActive==='Y'?'Yes':'No'],
          ]},
          { heading: 'All licensees', rows: lhRows },
          { heading: 'Links', rows: [
            ['Sodir', p.baaFactPageUrl ? `<a href="${p.baaFactPageUrl}" target="_blank" style="color:#4a9eff">Open &#x2197;</a>` : null],
          ]}
        ]);
      });
      if(p.baaName) {
        if(labelState.units) {
          layer.bindTooltip(p.baaName,
            {permanent:true, direction:'center', className:'map-label map-label-unit', offset:[0,0]}
          );
        } else {
          const role = p.isOperator ? 'Operator' : 'Licensee';
          const myShare = p._myShare ? fmtPct(p._myShare) : null;
          layer.bindTooltip(
            `<strong>${p.baaName}</strong><br><span style="color:${col};font-size:11px">${role}${myShare ? ' · ' + myShare : ''}</span>`,
            {sticky:true, className:'tooltip-dark'}
          );
        }
      }
    }
  }).addTo(unitLayer);
}

function renderFields(geojson) {
  if (!geojson) return;
  fieldLayer.clearLayers();

  // Build feature list: optionally include shut-down and other fields
  let features = geojson.features.slice();
  if (!showShutdown) features = features.filter(f => !f.properties._shutDown);

  // Merge in other NCS fields if toggle is on (drawn below Aker BP fields)
  if (showOtherFields && window._allFieldGeo) {
    features = [...window._allFieldGeo.features, ...features];
  }

  const filtered = { type: 'FeatureCollection', features };
  L.geoJSON(filtered, {
    pane: 'fieldPane',
    pointToLayer(f, latlng) {
      const p = f.properties;
      const col = p._shutDown ? C_FLD_SD : C_FLD_OP;
      const opacity = p._other ? 0.15 : (p._shutDown ? 0.25 : 0.9);
      return L.circleMarker(latlng, {
        pane: 'fieldPane', radius: p._other ? 6 : 8,
        fillColor: col, color: col, weight: p._other ? 1 : 2,
        fillOpacity: opacity
      });
    },
    style(f) {
      const p = f.properties;
      const shut = p._shutDown;
      const col = shut ? C_FLD_SD : C_FLD_OP;
      if (p._other) return { color: col, weight: 1, fillColor: col, fillOpacity: 0.10, opacity: 0.5 };
      return {
        color: col, weight: shut ? 1 : 2.5,
        fillColor: col, fillOpacity: shut ? 0.05 : 0.55,
        opacity: shut ? 0.30 : 1.0
      };
    },
    onEachFeature(feature, layer) {
      const p    = feature.properties;
      const shut = p._shutDown;
      const col  = shut ? C_FLD_SD : C_FLD_OP;
      const role = p._other ? 'No Aker BP interest' : (shut ? 'Shut down' : (p.isOperator ? 'Operator' : 'Owner'));
      const myShare = p._myShare ? fmtPct(p._myShare.total) : null;

      // Berik lisenshaverliste – vis ownerName (unit/lisens) for hver
      const lhRows = p._allLicensees.length > 0
        ? p._allLicensees
            .sort((a,b) => (b.share||0)-(a.share||0))
            .map(l => {
              const via = (l.ownerKind && l.ownerName) ? ` via ${l.ownerName}` : '';
              return [l.company||'?', fmtPct(l.share) + (l.sdfi ? ` (SDFI: ${fmtPct(l.sdfi)})` : '') + (via ? `<br><span style="color:#8ab0d0;font-size:11px">${l.ownerKind}${via}</span>` : '')];
            })
        : [];

      const shutHover   = {fillOpacity:0.15, weight:1.5};
      const normHover   = {fillOpacity:0.85, weight:3};
      const otherHover  = {fillOpacity:0.35, weight:1.5};
      const shutReturn  = {fillOpacity:0.05, weight:1, color:col, opacity:0.30};
      const normReturn  = {fillOpacity:0.55, weight:2.5, color:col, opacity:1.0};
      const otherReturn = {fillOpacity:0.10, weight:1, color:col, opacity:0.5};

      const hoverStyle  = p._other ? otherHover  : (shut ? shutHover  : normHover);
      const returnStyle = p._other ? otherReturn : (shut ? shutReturn : normReturn);

      layer.on('mouseover', () => layer.setStyle && layer.setStyle(hoverStyle));
      layer.on('mouseout',  () => layer.setStyle && layer.setStyle(returnStyle));
      layer.on('click', () => {
        showSidebar('Field: ' + (p.fldName||'?'), [
          { rows: [
            ['Field name', p.fldName],
            ...(p._other ? [] : [['Aker BP role', `<span style="color:${col}">${role}</span>`]]),
            ...(p._other ? [] : [['Aker BP share', myShare]]),
            ['Area', p.fldMainArea],
            ['Status', p.fldCurrentActivitySatus],
            ['HC type', p.fldHcType],
            ['Discovery', p.fldDiscoveryYear],
          ]},
          ...(lhRows.length>0 ? [{heading:'Ownership structure', rows:lhRows}] : []),
          { heading: 'Links', rows: [
            ['Sodir', p.fldFactPageUrl ? `<a href="${p.fldFactPageUrl}" target="_blank" style="color:#4a9eff">Open &#x2197;</a>` : null],
          ]}
        ]);
      });
      const name = p.fldName||'?';
      if(p._other) {
        layer.bindTooltip(
          `<strong>${name}</strong><br><span style="color:#00b373;font-size:11px">Other NCS field</span>`,
          {sticky:true, className:'tooltip-dark'}
        );
      } else {
        if(labelState.fields) {
          layer.bindTooltip(name,
            {permanent:true, direction:'top', className:'map-label map-label-field', offset:[0,-4]}
          );
        } else {
          layer.bindTooltip(
            `<strong>${name}</strong><br><span style="color:${col};font-size:11px">${role}${myShare ? ' · ' + myShare : ''}</span>`,
            {sticky:true, className:'tooltip-dark'}
          );
        }
      }
    }
  }).addTo(fieldLayer);
}

// ── Aker BP office locations ───────────────────────────────────────────────
const OFFICES = [
  { name: 'Head Office – Fornebu', address: 'Oksenøyveien 10, 1366 Lysaker',        lat: 59.8953, lng: 10.6267 },
  { name: 'Stavanger Office',         address: 'Jåttåflaten 28, 4020 Stavanger',      lat: 58.8943, lng: 5.6964  },
  { name: 'Trondheim Office',         address: 'Munkegata 26, 7011 Trondheim',           lat: 63.4305, lng: 10.3951 },
  { name: 'Sandnesjøen Office',    address: 'Øyvind Lambes vei 55, 8803 Sandnesjøen', lat: 66.0236, lng: 12.6354 },
  { name: 'Harstad Office',           address: 'Storåkeren 11, 9411 Harstad',           lat: 68.7988, lng: 16.5447 },
];

(function renderOffices() {
  OFFICES.forEach(o => {
    const m = L.circleMarker([o.lat, o.lng], {
      pane: 'officePane', radius: 7,
      fillColor: '#ffffff', color: '#4a9eff', weight: 2.5, fillOpacity: 0.95
    });
    if(labelState.offices) {
      m.bindTooltip(o.name,
        { permanent: true, direction: 'right', className: 'map-label map-label-office', offset: [8, 0] }
      );
    } else {
      m.bindTooltip(
        '<strong>' + o.name + '</strong><br><span style="font-size:11px;color:#8ab0d0">' + o.address + '</span>',
        { sticky: true, className: 'tooltip-dark' }
      );
    }
    m._officeData = o;
    m.on('click', () => showSidebar(o.name, [{ rows: [
      ['Address', o.address],
      ['Phone', '(+47) 51 35 30 00'],
      ['Maps', '<a href="https://www.google.com/maps/search/' + encodeURIComponent(o.address) + '" target="_blank" style="color:#4a9eff">Open in Maps &#x2197;</a>'],
    ]}]));
    m.addTo(officeLayer);
  });
})();


// ── Customisation ─────────────────────────────────────────────────────────

const DEFAULTS = {
  LIC_OP:  '#ce0f69', LIC_LH:  '#f68d2e',
  UNIT_OP: '#ce0f69', UNIT_LH: '#f68d2e',
  FLD_OP:  '#00b373', FLD_OW:  '#00b373', FLD_SD: '#ffffff'
};

function toggleCarbonLicences(visible) {
  showCarbonLicences = visible;
  renderUnits(window._unitGeo);
}

function toggleShutdown(visible) {
  showShutdown = visible;
  renderFields(window._fieldGeo);
}

function toggleOtherFields(visible) {
  showOtherFields = visible;
  if (visible && !window._allFieldGeo) {
    loadAllFields();
  } else {
    renderFields(window._fieldGeo);
  }
}


function toggleCustomise() {
  const panel = document.getElementById('customise-panel');
  panel.classList.toggle('hidden');
  // Close sidebar if open to avoid overlap
  if (!panel.classList.contains('hidden')) {
    document.getElementById('sidebar').classList.add('hidden');
  }

}



function resetCustomise() {
  Object.entries(DEFAULTS).forEach(([k, v]) => {
    document.getElementById('col-' + k.toLowerCase().replace('_', '-')).value = v;
  });
  // Reset labels
  ['licences','fields','offices','discoveries'].forEach(t => {
    labelState[t] = false;
    document.getElementById('lbl-' + t).checked = false;
    applyLabelVisibility(t, false);
  });
  labelState.units = false;
  applyLabelVisibility('units', false);
  showCarbonLicences = false;
  document.getElementById('vis-carbon').checked = false;
  renderUnits(window._unitGeo);
  showShutdown = false;
  document.getElementById('vis-shutdown').checked = false;
  showOtherFields = false;
  document.getElementById('vis-other-fields').checked = false;
  window._allFieldGeo = null;
  renderFields(window._fieldGeo);
  showOtherDiscoveries = false;
  document.getElementById('vis-other-discoveries').checked = false;
  renderDiscoveries();
}

function toggleLabels(type, visible) {
  labelState[type] = visible;
  applyLabelVisibility(type, visible);
}

function applyLabelVisibility(type, visible) {
  // For map layers: re-render respects labelState (tooltips are bound
  // conditionally in render). For offices, toggle directly.
  if (type === 'licences') renderLicences(window._licGeo);
  else if (type === 'units') renderUnits(window._unitGeo);
  else if (type === 'fields') renderFields(window._fieldGeo);
  else if (type === 'discoveries') renderDiscoveries();
  else if (type === 'ukLicences') { if (window._ukGeo) renderUKLicences(window._ukGeo); }
  else if (type === 'offices') {
    officeLayer.eachLayer(l => {
      if (visible) {
        if (l._officeData) {
          if (visible) {
            l.bindTooltip(l._officeData.name,
              { permanent: true, direction: 'right', className: 'map-label map-label-office', offset: [8, 0] }
            );
          } else {
            l.bindTooltip(
              '<strong>' + l._officeData.name + '</strong><br><span style="font-size:11px;color:#8ab0d0">' + l._officeData.address + '</span>',
              { sticky: true, className: 'tooltip-dark' }
            );
          }
        }
      } else {
        l.unbindTooltip();
      }
    });
  }
}





// ── Load all NCS fields (for "other fields" overlay) ─────────────────────
async function loadAllFields() {
  if (window._allFieldGeo) { renderFields(window._fieldGeo); return; }
  setLoading('Loading all NCS fields...');
  try {
    // Fetch all producing/discovery fields from lag 7100
    // We want fields NOT already in Aker BP portfolio
    const akerbpIds = new Set((window._fieldGeo?.features || []).map(f => f.properties.fldNpdidField));
    let rows = [];
    let offset = 0;
    while (true) {
      const body = new URLSearchParams({
        where: "fldCurrentActivitySatus NOT IN ('Shut down','Abandoned','Returned to authorities')",
        outFields: 'fldNpdidField,fldName,fldMainArea,fldCurrentActivitySatus,fldHcType,fldDiscoveryYear,fldFactPageUrl',
        f: 'json', returnGeometry: 'true', outSR: '4326',
        resultRecordCount: '500', resultOffset: String(offset)
      });
      const d = await (await fetch(`${BASE}/7100/query`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
      })).json();
      if (d.error) throw new Error(d.error.message);
      rows = rows.concat(d.features || []);
      if (!d.exceededTransferLimit || (d.features||[]).length === 0) break;
      offset += (d.features||[]).length;
    }
    // Keep only fields NOT in Aker BP portfolio
    const otherRows = rows.filter(f => !akerbpIds.has(f.attributes.fldNpdidField));
    const geo = toGeoJSON(otherRows);
    geo.features.forEach(f => {
      f.properties._other = true;
      f.properties._shutDown = false;
      f.properties.isOperator = false;
      f.properties._myShare = null;
      f.properties._allLicensees = [];
    });
    window._allFieldGeo = geo;
    console.log('Other NCS fields loaded:', geo.features.length);
  } catch(e) {
    console.error('loadAllFields error:', e);
    showError('Error loading other fields: ' + e.message);
  }
  setLoading(null);
  renderFields(window._fieldGeo);
}


// ── Discovery colours ─────────────────────────────────────────────────────
// C_DISC = '#ffdc00' defined above with colour constants

// ── Load Aker BP discoveries (points from lag 7060 or 7050) ──────────────
// Sodir discovery layer: wellbore discovery points are typically in the
// wlbPoint layers. The factmaps discovery polygon layer is in the 5000-range.
// We probe the known discovery point layer (7050) and polygon layer (5060).

async function loadAkerbpDiscoveries(licGeo) {
  // Build set of licence IDs where Aker BP is involved
  const akerbpLicIds = new Set(licGeo.features.map(f => f.properties.prlNpdidLicence));

  // Probe for discovery layer in DataService/Data MapServer.
  // Known layer IDs from FactMaps_ogc: 503 (active), 504 (all).
  // DataService/Data may use different numbering — probe broadly.
  // Fields: dscNpdidDiscovery, dscName, dscCurrentActivityStatus, prlNpdidLicence, dscFactPageUrl
  // Some layers use prlNpdidProdLicence instead of prlNpdidLicence.
  let discoveryLayerId = null;
  let discoveryFields  = null;
  let licenceIdField   = null;

  // Discovery layer is 7000 in DataService/Data.
  // Probe with minimal fields first to confirm layer works, then check available fields.
  const discoveryBase = BASE;

  // Layer 7000 = discovery polygons. Known fields (no licence ID — use layer 7003 for that).
  discoveryLayerId = 7000;
  discoveryFields  = 'dscNpdidDiscovery,dscName,dscCurrentActivityStatus,dscFactPageUrl,dscDiscoveryYear,dscHcType,cmpLongName,cmpNpdidCompany,nmaName,fldName,fldNpdidField';
  licenceIdField   = null;

  if (discoveryLayerId === null) {
    console.warn('No discovery layer found in DataService/Data – skipping');
    setLoading(null);
    return;
  }

  // Load all discoveries (paginated)
  let rows = [];
  let offset = 0;
  while (true) {
    const body = new URLSearchParams({
      where: "dscCurrentActivityStatus NOT IN ('Included in other discovery','Producing','Shut down')", outFields: discoveryFields, f: 'json',
      returnGeometry: 'true', outSR: '4326',
      resultRecordCount: '500', resultOffset: String(offset)
    });
    const d = await (await fetch(`${discoveryBase}/${discoveryLayerId}/query`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body.toString()
    })).json();
    if (d.error) { console.warn('Discovery query error:', d.error.message); break; }
    rows = rows.concat(d.features || []);
    if (!d.exceededTransferLimit || (d.features||[]).length === 0) break;
    offset += (d.features||[]).length;
  }

  console.log('Total discoveries loaded:', rows.length);

  // Use layer 7003 (discovery_licensee table) to get ALL discoveries where
  // Aker BP has any interest (operator or licensee).
  setLoading('Loading Aker BP discovery interests...');
  const akerbpDiscIds = new Set();
  try {
    const rows7003 = await queryAll(7003,
      `cmpNpdidCompany = ${AKERBP_ID}`,
      'dscNpdidDiscovery');
    rows7003.forEach(f => akerbpDiscIds.add(f.attributes.dscNpdidDiscovery));
    console.log('Aker BP discovery interests (lag 7003):', akerbpDiscIds.size);
  } catch(e) { console.warn('Layer 7003 query failed:', e.message); }

  const akerbpDisc = [], otherDisc = [];
  rows.forEach(f => {
    if (akerbpDiscIds.has(f.attributes.dscNpdidDiscovery)) akerbpDisc.push(f);
    else otherDisc.push(f);
  });

  const toGeoD = (arr, isOther) => {
    const geo = toGeoJSON(arr);
    geo.features.forEach(f => { f.properties._other = isOther; f.properties._isDiscovery = true; });
    return geo;
  };

  window._discAkerbpGeo = toGeoD(akerbpDisc, false);
  window._discOtherGeo  = toGeoD(otherDisc, true);
  console.log(`Discoveries – Aker BP: ${akerbpDisc.length}, other: ${otherDisc.length}`);

  renderDiscoveries();
  document.getElementById('discoveryCount').textContent = akerbpDisc.length;
  setLoading(null);
}

function renderDiscoveries() {
  discoveryLayer.clearLayers();
  if (!window._discAkerbpGeo) return;

  const features = [
    ...(showOtherDiscoveries && window._discOtherGeo ? window._discOtherGeo.features : []),
    ...window._discAkerbpGeo.features,
  ];
  const geo = { type: 'FeatureCollection', features };

  L.geoJSON(geo, {
    pane: 'discoveryPane',
    pointToLayer(f, latlng) {
      const other = f.properties._other;
      return L.circleMarker(latlng, {
        pane: 'discoveryPane',
        radius: other ? 5 : 7,
        fillColor: C_DISC,
        color: C_DISC,
        weight: other ? 1 : 2,
        fillOpacity: other ? 0.20 : 0.75
      });
    },
    style(f) {
      const other = f.properties._other;
      return {
        color: C_DISC, weight: other ? 1 : 2,
        fillColor: C_DISC,
        fillOpacity: other ? 0.10 : 0.45,
        opacity: other ? 0.4 : 0.9
      };
    },
    onEachFeature(feature, layer) {
      const p = feature.properties;
      const other = p._other;
      const name = p.dscName || '?';
      const status = p.dscCurrentActivityStatus || '';

      const hoverStyle  = { fillOpacity: other ? 0.45 : 0.95, weight: other ? 1.5 : 3 };
      const returnStyle = { fillOpacity: other ? 0.10 : 0.45, weight: other ? 1 : 2 };

      layer.on('mouseover', () => layer.setStyle && layer.setStyle(hoverStyle));
      layer.on('mouseout',  () => layer.setStyle && layer.setStyle(returnStyle));
      layer.on('click', () => {
        showSidebar('Discovery: ' + name, [{ rows: [
          ['Name', name],
          ['Status', status],
          ['HC type',       p.dscHcType || null],
          ['Discovery year',p.dscDiscoveryYear || null],
          ['Operator',      p.cmpLongName || null],
          ['Area',          p.nmaName || null],
          ['Aker BP',       other ? 'No' : '<span style="color:#ffdc00">Yes</span>'],
          ['Related field', p.fldName || null],
          ...(p.dscFactPageUrl ? [['Sodir', `<a href="${p.dscFactPageUrl}" target="_blank" style="color:#4a9eff">Open &#x2197;</a>`]] : [])
        ]}]);
      });

      if(other) {
        layer.bindTooltip(
          `<strong>${name}</strong><br><span style="color:#ffdc00;font-size:11px">${p.dscHcType||''}</span>`,
          {sticky:true, className:'tooltip-dark'}
        );
      } else {
        if(labelState.discoveries) {
          layer.bindTooltip(name, {
            permanent: true, direction: 'right',
            className: 'map-label map-label-discovery', offset: [6, 0]
          });
        } else {
          layer.bindTooltip(
            `<strong>${name}</strong><br><span style="color:#ffdc00;font-size:11px">${p.dscHcType||''}</span>`,
            {sticky:true, className:'tooltip-dark'}
          );
        }
      }
    }
  }).addTo(discoveryLayer);
}

function toggleOtherDiscoveries(visible) {
  showOtherDiscoveries = visible;
  renderDiscoveries();
}










// ─── UK LICENSER (NSTA) ───────────────────────────────────────────────────
const C_UK_LIC = '#00cfff';

async function loadUKLicences() {
  // Hent Aker BP UK-lisenser fra NSTA FeatureServer
  // ADMORGNO = selskapsnummer for lisensadministrator
  // Aker BP UK Limited = 12908310
  // Vi henter også lisenser der LICORG inneholder selskapsnummeret (medeier)
  const where = encodeURIComponent(`ADMORGNO='12908310' OR LICORG LIKE '%12908310%'`);
  const url = `${NSTA_BASE}/0/query?where=${where}&outFields=LICREF,LICNO,LICPREFIX,LICTYPE,LICSTATUS,LICORG,ADMORG,ADMORGNO,BLOCKREF,FIELDS,LICSTARTDT,LICENDDT,RNDNO,RNDTYPE,REGIONS,URL&returnGeometry=true&outSR=4326&f=geojson`;

  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`NSTA HTTP ${resp.status}`);
  const geojson = await resp.json();

  if (!geojson.features?.length) {
    return;
  }

  window._ukGeo = geojson;
  renderUKLicences(geojson);
  // Summer UK-lisenser inn i licenceCount
  const norCount = parseInt(document.getElementById('licenceCount').textContent) || 0;
  document.getElementById('licenceCount').textContent = norCount + geojson.features.length;
  console.log(`UK lisenser: ${geojson.features.length}`);
}

function renderUKLicences(geojson) {
  ukLicenceLayer.clearLayers();

  L.geoJSON(geojson, {
    pane: 'licencePane',
    style: () => polyStyle(C_UK_LIC, true, false),
    onEachFeature(feature, layer) {
      const p = feature.properties;

      const licRef   = p.LICREF   || `P${p.LICNO}`;
      const licType  = p.LICTYPE  || '–';
      const status   = p.LICSTATUS|| '–';
      const blocks   = p.BLOCKREF || '–';
      const fields   = p.FIELDS   || '–';
      const org      = p.LICORG   || p.ADMORG || '–';
      const region   = p.REGIONS  || '–';
      const round    = p.RNDNO    ? `${p.RNDTYPE || 'Round'} ${p.RNDNO}` : '–';

      const fmtDate = ts => {
        if (!ts) return '–';
        try { return new Date(ts).toLocaleDateString('en-GB', {year:'numeric',month:'short'}); }
        catch { return '–'; }
      };

      const ukStyle = () => polyStyle(C_UK_LIC, true, false);

      layer.on('mouseover', () => layer.setStyle({fillOpacity:0.42, weight:2.5}));
      layer.on('mouseout',  () => layer.setStyle(ukStyle()));
      layer.on('click', () => {
        showSidebar(`🇬🇧 UK Licence: ${licRef}`, [
          { rows: [
            ['Licence ref', licRef],
            ['Type', licType],
            ['Status', `<span style="color:${status==='Extant'?'#00d080':'#f68d2e'}">${status}</span>`],
            ['Blocks', blocks],
            ['Fields', fields],
            ['Region', region],
            ['Round', round],
            ['Start', fmtDate(p.LICSTARTDT)],
            ['End', fmtDate(p.LICENDDT)],
          ]},
          { heading: 'Licensee(s)', rows: [[org, null]] },
          { heading: 'Links', rows: [
            ['NSTA licence doc', p.URL
              ? `<a href="${p.URL}" target="_blank" style="color:#4a9eff">Open PDF &#x2197;</a>`
              : null],
            ['NSTA data portal', `<a href="https://open-data-ukcs-transition.hub.arcgis.com" target="_blank" style="color:#4a9eff">Open &#x2197;</a>`],
          ]}
        ]);
      });

      // Tooltip — samme logikk som norske lisenser
      if (licRef) {
        if (labelState.ukLicences) {
          layer.bindTooltip(licRef,
            {permanent:true, direction:'center', className:'map-label map-label-licence', offset:[0,0]}
          );
        } else {
          layer.bindTooltip(
            `<strong>${licRef}</strong><br><span style="color:${C_UK_LIC};font-size:11px">🇬🇧 UK Licence</span>`,
            {sticky:true, className:'tooltip-dark'}
          );
        }
      }
    }
  }).addTo(ukLicenceLayer);
}


loadData();
</script>
</body>
</html>
